name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run linting
      run: npm run lint
      
    - name: Run type checking
      run: npm run type-check
      
    - name: Run tests
      run: npm run test
      
    - name: Run tests with coverage
      run: npm run test:coverage
      
    - name: Generate enhanced HTML report
      run: npm run report:generate
      
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          playwright-report/
          test-results/
          custom-reports/
          coverage/
        retention-days: 30
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          let comment = '## 🧪 Test Results\n\n';
          
          try {
            const testResults = fs.readFileSync('test-results/test-results.json', 'utf8');
            const results = JSON.parse(testResults);
            comment += `✅ **Tests Passed**: ${results.stats.passed}\n`;
            comment += `❌ **Tests Failed**: ${results.stats.failed}\n`;
            comment += `⏱️ **Duration**: ${results.stats.duration}ms\n\n`;
          } catch (e) {
            comment += '⚠️ Could not read test results\n\n';
          }
          
          comment += '📊 **Reports Generated:**\n';
          comment += '- Playwright HTML Report\n';
          comment += '- Enhanced Custom Report\n';
          comment += '- Test Results (JSON)\n';
          comment += '- JUnit XML Report\n\n';
          
          comment += '📥 **Download Reports:** [View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n';
          
          comment += '🚀 **Quick Actions:**\n';
          comment += '- Run tests locally: `npm test`\n';
          comment += '- Generate report: `npm run report:generate`\n';
          comment += '- View report: `npm run report:open`';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Comment on push
      if: github.event_name == 'push'
      run: |
        echo "## 🚀 Tests Completed Successfully" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ **All tests passed**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📊 **Reports Generated:**" >> $GITHUB_STEP_SUMMARY
        echo "- Playwright HTML Report" >> $GITHUB_STEP_SUMMARY
        echo "- Enhanced Custom Report" >> $GITHUB_STEP_SUMMARY
        echo "- Test Results (JSON)" >> $GITHUB_STEP_SUMMARY
        echo "- JUnit XML Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "📥 **Download Reports:** Check the Actions tab for artifacts" 